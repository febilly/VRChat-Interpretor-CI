<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VRChat 翻译器控制面板</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>🎤 VRChat 翻译器控制面板</h1>
            <div class="status-indicator">
                <span id="status-text">服务未运行</span>
                <div class="status-dot" id="status-dot"></div>
            </div>
        </header>

        <main>
            <!-- 服务控制区域 -->
            <section class="card">
                <h2>服务控制</h2>
                <div class="control-buttons">
                    <button id="start-btn" class="btn btn-success" onclick="startService()">启动服务</button>
                    <button id="stop-btn" class="btn btn-danger" onclick="stopService()" disabled>停止服务</button>
                    <button id="reset-btn" class="btn btn-warning" onclick="resetToDefaults()">恢复默认设置</button>
                </div>
            </section>

            <!-- API Keys配置 -->
            <section class="card">
                <div class="collapsible-header" onclick="toggleCollapsible('api-keys')">
                    <h2>API Keys 配置</h2>
                    <span class="collapse-icon" id="api-keys-icon">▼</span>
                </div>
                <div class="collapsible-content" id="api-keys">
                    <div class="api-key-group">
                        <label for="dashscope-api-key">阿里云 DashScope API Key (必需)</label>
                        <input type="password" id="dashscope-api-key" class="form-control" placeholder="sk-...">
                        <small class="form-text">
                            <a href="https://bailian.console.aliyun.com/?tab=model#/model-market/detail/fun-asr-realtime" target="_blank">获取API Key →</a>
                        </small>
                    </div>
                    
                    <div class="api-key-group">
                        <label for="deepl-api-key">DeepL API Key (可选，用于翻译)</label>
                        <input type="password" id="deepl-api-key" class="form-control" placeholder="...">
                        <small class="form-text">
                            <a href="https://www.deepl.com/en/pro-api" target="_blank">获取API Key →</a>
                        </small>
                    </div>
                    
                    <div class="api-key-group">
                        <label for="openrouter-api-key">OpenRouter API Key (可选，用于LLM翻译)</label>
                        <input type="password" id="openrouter-api-key" class="form-control" placeholder="sk-or-...">
                        <small class="form-text">
                            <a href="https://openrouter.ai/" target="_blank">获取API Key →</a>
                        </small>
                    </div>
                </div>
            </section>

            <!-- 基本设置 -->
            <section class="card">
                <h2>基本设置</h2>
                
                <div class="form-group">
                    <label class="switch-label">
                        <span>启用翻译</span>
                        <label class="switch">
                            <input type="checkbox" id="enable-translation" onchange="onSettingChange(); toggleTranslationOptions()">
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>

                <div id="translation-options">
                    <div class="form-group">
                        <label for="target-language">目标语言</label>
                        <select id="target-language" class="form-control" onchange="onSettingChange()">
                            <option value="zh">中文</option>
                            <option value="en">英语</option>
                            <option value="ja">日语</option>
                            <option value="ko">韩语</option>
                            <option value="es">西班牙语</option>
                            <option value="fr">法语</option>
                            <option value="de">德语</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="fallback-language">备用语言（当源语言与目标语言相同时使用）</label>
                        <select id="fallback-language" class="form-control" onchange="onSettingChange()">
                            <option value="">禁用</option>
                            <option value="zh">中文</option>
                            <option value="en">英语</option>
                            <option value="ja">日语</option>
                            <option value="ko">韩语</option>
                        </select>
                    </div>
                </div>
            </section>

            <!-- 翻译API设置 -->
            <section class="card">
                <div class="collapsible-header" onclick="toggleCollapsible('translation-api')">
                    <h2>翻译API设置</h2>
                    <span class="collapse-icon" id="translation-api-icon">▼</span>
                </div>
                <div class="collapsible-content" id="translation-api">
                    <div class="form-group">
                        <label for="translation-api-type">翻译API</label>
                        <select id="translation-api-type" class="form-control" onchange="onSettingChange()">
                            <option value="deepl">DeepL（高质量）</option>
                            <option value="google_web">Google Web（免费）</option>
                            <option value="google_dictionary">Google Dictionary（快速）</option>
                            <option value="openrouter">OpenRouter（LLM）</option>
                        </select>
                    </div>
                </div>
            </section>

            <!-- 语音识别设置 -->
            <section class="card">
                <div class="collapsible-header" onclick="toggleCollapsible('asr-settings')">
                    <h2>语音识别设置</h2>
                    <span class="collapse-icon" id="asr-settings-icon">▼</span>
                </div>
                <div class="collapsible-content" id="asr-settings">
                    <div class="form-group">
                        <label for="asr-backend">识别后端</label>
                        <select id="asr-backend" class="form-control" onchange="onSettingChange()">
                            <option value="qwen">Qwen3 ASR（推荐，快速）</option>
                            <option value="dashscope">Fun-ASR（稳定）</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="switch-label">
                            <span>启用热词</span>
                            <label class="switch">
                                <input type="checkbox" id="enable-hot-words" onchange="onSettingChange()">
                                <span class="slider"></span>
                            </label>
                        </label>
                        <small class="form-text">提高特定词汇的识别准确度</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="switch-label">
                            <span>麦克风控制（根据VRChat麦克风状态控制识别）</span>
                            <label class="switch">
                                <input type="checkbox" id="enable-mic-control" onchange="onSettingChange()">
                                <span class="slider"></span>
                            </label>
                        </label>
                    </div>

                    <div class="form-group">
                        <label for="mute-delay">静音延迟（秒）</label>
                        <input type="number" id="mute-delay" class="form-control" min="0" max="5" step="0.1" value="0.2" onchange="onSettingChange()">
                        <small class="form-text">静音后延迟停止识别的时间，防止漏掉最后一个字</small>
                    </div>
                </div>
            </section>

            <!-- 高级设置（折叠） -->
            <section class="card">
                <div class="collapsible-header" onclick="toggleCollapsible('advanced-settings')">
                    <h2>高级设置</h2>
                    <span class="collapse-icon collapsed" id="advanced-settings-icon">▶</span>
                </div>
                <div class="collapsible-content collapsed" id="advanced-settings">
                    <!-- VAD设置 -->
                    <div class="subsection">
                        <h3>VAD（语音活动检测）设置 - 仅Qwen后端</h3>
                        
                        <div class="form-group">
                            <label class="switch-label">
                                <span>启用VAD</span>
                                <label class="switch">
                                    <input type="checkbox" id="enable-vad" onchange="onSettingChange()">
                                    <span class="slider"></span>
                                </label>
                            </label>
                            <small class="form-text">自动检测语音结束并断句</small>
                        </div>

                        <div class="form-group">
                            <label for="vad-threshold">VAD阈值（0.0-1.0）</label>
                            <input type="number" id="vad-threshold" class="form-control" min="0" max="1" step="0.05" value="0.2" onchange="onSettingChange()">
                            <small class="form-text">值越小越敏感，越容易触发断句</small>
                        </div>

                        <div class="form-group">
                            <label for="vad-silence-duration">VAD静音持续时间（毫秒）</label>
                            <input type="number" id="vad-silence-duration" class="form-control" min="100" max="3000" step="100" value="800" onchange="onSettingChange()">
                            <small class="form-text">检测到此时长的静音后触发断句</small>
                        </div>
                    </div>

                    <!-- WebSocket保活设置 -->
                    <div class="subsection">
                        <h3>WebSocket保活设置 - 仅Qwen后端</h3>
                        
                        <div class="form-group">
                            <label for="keepalive-interval">心跳间隔（秒）</label>
                            <input type="number" id="keepalive-interval" class="form-control" min="0" max="120" step="5" value="30" onchange="onSettingChange()">
                            <small class="form-text">防止长时间闲置导致连接超时，设置为0禁用</small>
                        </div>
                    </div>

                    <!-- 语言检测器设置 -->
                    <div class="subsection">
                        <h3>语言检测器设置</h3>
                        
                        <div class="form-group">
                            <label for="language-detector">检测器类型</label>
                            <select id="language-detector" class="form-control" onchange="onSettingChange()">
                                <option value="cjke">中日韩英检测器（推荐）</option>
                                <option value="enzh">中英检测器</option>
                                <option value="fasttext">通用检测器（支持更多语言）</option>
                            </select>
                        </div>
                    </div>

                    <!-- 源语言设置 -->
                    <div class="subsection">
                        <h3>源语言设置</h3>
                        
                        <div class="form-group">
                            <label for="source-language">源语言</label>
                            <select id="source-language" class="form-control" onchange="onSettingChange()">
                                <option value="auto">自动检测</option>
                                <option value="zh">中文</option>
                                <option value="en">英语</option>
                                <option value="ja">日语</option>
                                <option value="ko">韩语</option>
                            </select>
                            <small class="form-text">建议保持"自动检测"</small>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 状态消息 -->
            <div id="message" class="message"></div>
        </main>

        <footer>
            <p>VRChat 翻译器 © 2024 | <a href="https://github.com/febilly/VRChat-Interpretor-CI" target="_blank">GitHub</a></p>
        </footer>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
